<html>
<head>
<title>updater</title>
</head>
<body>
<div id="version"></div>
<div id="loaded"></div>
<script>
  var gui = require('nw.gui');
  var copyPath;
  if(gui.App.argv.length){
    copyPath = gui.App.argv[0];
  }
  
 //download new version of app in tmp
  //unpack
  //run updater
  //updater will copy itself to origin directory
  //updater will run app
  var pkg = require('./package.json');
  var request = require('request');
  var path = require('path');
  var exec = require('child_process').exec;
  var execFile = require('child_process').execFile;
  var ncp = require('ncp');
  var os = require('os');
  var fs = require('fs');
  var k = 0;
  var d = false;
  var isWin = /^win/.test(process.platform);
  var isMac = /^darwin/.test(process.platform);
  var isLinux = /^linux/.test(process.platform);
  //npm install unzip

  var manifestUrl = pkg.manifestUrl;
  var macPkgUrl = pkg.packages.mac;
  
  var pkgUrl;
  
  if(isMac) pkgUrl = pkg.packages.mac;
  if(isWin) pkgUrl = pkg.packages.win;
  if(isLinux) pkgUrl = pkg.packages.linux;

  
  if(!copyPath){
    document.getElementById('version').innerHTML = 'current version ' + pkg.version;
    setInterval(function(){
      if(!d) checkForUpdates(pkg.version, newVersionAvailable);
    }, 500);
  } else {
    console.log("I will copy from", path.resolve(process.cwd(),'../../..'));
    console.log("I will compy to", copyPath);
    document.getElementById('version').innerHTML = 'copying app';

    ncp(path.resolve(process.cwd(),'../../..'), copyPath, appCopied);

    function appCopied(err){
      if(err){
        return console.log(err);
      }
      exec('open ' + copyPath);
      process.exit();
    }
  }
  
  function checkForUpdates(currentVersion, cb){
    request.get(manifestUrl, gotManifest);
    function gotManifest(err, req, data){
      if(err) {
        return cb(err);
      }
      try{
        data = JSON.parse(data);
      } catch(e){
        return cb(e)
      }
      if(data.version !== currentVersion){
        document.getElementById('loaded').innerHTML = "New version found ";
        cb(null, data.version);
      }
    }
  }
  function newVersionAvailable(err, version){
    if(err || d){
      return;
    }
    d = true;
    var pkgRequest = request(pkgUrl);
    console.log("start new dwnload");
    var filename;
    if(isMac) filename = 'updater.dmg';
    if(isWin) filename = 'updater.zip';
    if(isLinux) filename = 'updater.tar.gz';

    pkgRequest.pipe(fs.createWriteStream(path.join(os.tmpdir(), filename)));
    pkgRequest.on('end', updaterDownloaded);
    var loaded = 0;
    pkgRequest.on('data', function(data){
      loaded += data.length;
      document.getElementById('loaded').innerHTML = "New version loading " + Math.floor(loaded / 1024) + 'kb';
    })
    function updaterDownloaded(chunk){
      if(isMac) mount(path.join(os.tmpdir(), 'updater.dmg'), 'updapp', mounted);
      if(isWin) {
        console.log(path.join(os.tmpdir(), filename));
        var zip = new AdmZip(path.join(os.tmpdir(), filename));
        zip.extractAllTo(path.join(os.tmpdir(), 'updater'));
      }
    }
    function mounted(mountPoint){
      exec('open ' + mountPoint + '/updapp.app --args ' + path.resolve(process.cwd(),'../../..'), function(){
        console.log(arguments);
      });
      
      process.exit();

      console.log('mounted at ' + mountPoint);
    }
    //download
    //unpack
  }
  function mount(dmg, dmg_name, callback) {
    var self = this;
    exec('hdiutil attach ' + dmg + ' -nobrowse', function(err){
      if(err) throw err;
      findMountPoint(dmg_name, callback);
    });
  }
  function findMountPoint(dmg_name, callback) {
    exec('hdiutil info', function(err, stdout){
      if (err) throw err;
      var results = stdout.split("\n");
      for (var i=0,l=results.length;i<l;i++) {
        if (results[i].match(dmg_name)) {
          console.log(results[i].split("\t"));
          callback(results[i].split("\t").pop());
          return;
        }
      }
      throw "Mount point not found";
    })
  }
</script>
</body>
</html>
