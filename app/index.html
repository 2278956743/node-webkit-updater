<html>
<head>
<title>updater</title>
</head>
<body>
<div id="version"></div>
<div id="loaded"></div>
<script>
  var gui = require('nw.gui');
  var copyPath, origPid;
  if(gui.App.argv.length){
    copyPath = gui.App.argv[0];
    origPid = gui.App.argv[1];
  }

  //API
  //updater(manifest)
  // manifest.url - where to get manifest {version:'ver'}
  // manifest.pkg.mac/win/linux32/linux64
  // manifest.currentVersion
  // -------APP--------
  // checkNewVersion(cb) - checks new version of app
  // download(cb) - downloads new version in temp
  // unpack(cb) - unpacks the version
  // runInstaller(cb) - is starting the installer
  // -------INSTALLER---
  // install(cb) - installs the app in app folder
  // runApp(cb) - starting the app



  //download new version of app in tmp
  //unpack
  //run updater
  //updater will copy itself to origin directory
  //updater will run app
  var pkg = require('./package.json');
  var request = require('request');
  var path = require('path');
  var targz = require('tar.gz');
  var exec = require('child_process').exec;
  var execFile = require('child_process').execFile;
  var spawn = require('child_process').spawn;
  var ncp = require('ncp');
  var os = require('os');
  var fs = require('fs');
  var k = 0;
  var d = false;
  var isWin = /^win/.test(process.platform);
  var isMac = /^darwin/.test(process.platform);
  var isLinux = /^linux/.test(process.platform);
  //npm install unzip

  var manifestUrl = pkg.manifestUrl;
  var macPkgUrl = pkg.packages.mac;
  
  var pkgUrl;
  
  if(isMac) pkgUrl = pkg.packages.mac;
  if(isWin) pkgUrl = pkg.packages.win;
  if(isLinux) pkgUrl = pkg.packages.linux32;

  
  if(!copyPath){
    document.getElementById('version').innerHTML = 'current version ' + pkg.version;
    setInterval(function(){
      if(!d) checkForUpdates(pkg.version, newVersionAvailable);
    }, 500);
  } else {
    console.log("I will copy from", path.resolve(process.cwd(),'../../..'));
    console.log("I will compy to", copyPath);
    document.getElementById('version').innerHTML = 'copying app';
    if(isLinux) ncp(path.dirname(process.execPath), copyPath, appCopied);
    if(isMac) ncp(path.resolve(process.cwd(),'../../..'), copyPath, appCopied);
    if(isWin) {
      deleteApp(appDeleted);
      function appDeleted(err){
        ncp(path.resolve(path.dirname(process.execPath)), copyPath, appCopied);
      }
    }

    function deleteApp(cb){
      exec('rd ' + copyPath + '/s /q', cb)
    }

    function appCopied(err){
      if(err){
        if(isWin) setTimeout(function(){deleteApp(appDeleted);}, 500);
        return console.log(err);
      }
      if(isMac) exec('open ' + copyPath);
      if(isLinux) {
        exec(copyPath + '/updapp', {cwd: copyPath});
      }
      if(isWin) {
        //need to kill previous updapp process though
        //http://stackoverflow.com/questions/11276249/how-to-kill-an-open-process-on-node-js
        var sp = spawn(path.join(copyPath, '/updapp.exe'), []
        ,{detached: true});
        sp.unref();
      }
      process.exit();
    }
  }
  
  function checkForUpdates(currentVersion, cb){
    request.get(manifestUrl, gotManifest);
    function gotManifest(err, req, data){
      if(err) {
        return cb(err);
      }
      try{
        data = JSON.parse(data);
      } catch(e){
        return cb(e)
      }
      if(data.version !== currentVersion){
        document.getElementById('loaded').innerHTML = "New version found ";
        cb(null, data.version);
      }
    }
  }
  function newVersionAvailable(err, version){
    if(err || d){
      return;
    }
    d = true;
    var pkgRequest = request(pkgUrl);
    console.log("start new dwnload");
    var filename;
    if(isMac) filename = 'updater.dmg';
    if(isWin) filename = 'updater.zip';
    if(isLinux) filename = 'updater.tar.gz';

    pkgRequest.pipe(fs.createWriteStream(path.join(os.tmpdir(), filename)));
    pkgRequest.on('end', updaterDownloaded);
    var loaded = 0;
    pkgRequest.on('data', function(data){
      loaded += data.length;
      document.getElementById('loaded').innerHTML = "New version loading " + Math.floor(loaded / 1024) + 'kb';
    })
    function updaterDownloaded(chunk){
      if(isMac) mount(path.join(os.tmpdir(), 'updater.dmg'), 'updapp', mounted);
      if(isLinux){
        var gzip = new targz();
        document.getElementById('loaded').innerHTML = "Unpacking... please wait!";
        return gzip.extract(path.join(os.tmpdir(), filename), path.join(os.tmpdir(), '/updapp'), mounted);
      }
      if(isWin) {
        exec(path.resolve(path.dirname(process.execPath),'tools/unzip.exe') + " -u -o " + 
          path.join(os.tmpdir(), filename) + " -d " + os.tmpdir(), mounted);
      }
    }
    function mounted(mountPoint){
      console.log(arguments);
      if(isMac) exec('open ' + mountPoint + '/updapp.app --args ' + path.resolve(process.cwd(),'../../..'));
      if(isLinux){
        fs.chmodSync(path.join(os.tmpdir(), 'updapp/linux32/linux32/updapp/updapp'), 0755);
        /*exec(path.join(os.tmpdir(), 'updapp/linux32/linux32/updapp/updapp') + ' ' + path.dirname(process.execPath), 
          function(){
            console.log(arguments)
          }
        )*/
        var sp = spawn(path.join(os.tmpdir(), 'updapp/linux32/linux32/updapp/updapp'), [path.dirname(process.execPath), process.pid]
        ,{detached: true , cwd: path.join(os.tmpdir(), 'updapp/linux32/linux32/updapp')});
        sp.unref();
      }
      if(isWin){ 
        var sp = spawn(path.join(os.tmpdir(), 'win/win/updapp/updapp.exe'), [path.dirname(process.execPath), process.pid]
        ,{detached: true});
        sp.unref();
      }
      
      process.exit();
      console.log('mounted at ' + mountPoint);
    }
    //download
    //unpack
  }
  function mount(dmg, dmg_name, callback) {
    var self = this;
    exec('hdiutil attach ' + dmg + ' -nobrowse', function(err){
      if(err) throw err;
      findMountPoint(dmg_name, callback);
    });
  }
  function findMountPoint(dmg_name, callback) {
    exec('hdiutil info', function(err, stdout){
      if (err) throw err;
      var results = stdout.split("\n");
      for (var i=0,l=results.length;i<l;i++) {
        if (results[i].match(dmg_name)) {
          console.log(results[i].split("\t"));
          callback(results[i].split("\t").pop());
          return;
        }
      }
      throw "Mount point not found";
    })
  }
</script>
</body>
</html>
